---
// Componente para navegación de semanas - Diseño responsive mejorado
interface Props {
  currentDate: Date;
}

const { currentDate } = Astro.props;

const getWeekRange = (date: Date) => {
  const startOfWeek = new Date(date);
  const day = startOfWeek.getDay();
  const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1);
  startOfWeek.setDate(diff);

  const endOfWeek = new Date(startOfWeek);
  endOfWeek.setDate(startOfWeek.getDate() + 6);

  return {
    start: startOfWeek,
    end: endOfWeek
  };
};

const weekRange = getWeekRange(currentDate);

// Formatear rango de fechas para el título
const formatWeekTitle = (start: Date, end: Date) => {
  const startDay = start.getDate();
  const endDay = end.getDate();
  const startMonth = start.toLocaleDateString('es-ES', { month: 'short' }).replace('.', '');
  const endMonth = end.toLocaleDateString('es-ES', { month: 'short' }).replace('.', '');
  const year = end.getFullYear();

  if (start.getMonth() === end.getMonth()) {
    return `${startDay} - ${endDay} ${endMonth} ${year}`;
  }
  return `${startDay} ${startMonth} - ${endDay} ${endMonth} ${year}`;
};

// Obtener número de semana del año
const getWeekNumber = (date: Date) => {
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d.getTime() - yearStart.getTime()) / 86400000) + 1) / 7);
};

const weekNumber = getWeekNumber(currentDate);
const weekTitle = formatWeekTitle(weekRange.start, weekRange.end);
const dayName = currentDate.toLocaleDateString('es-ES', { weekday: 'long' });
const capitalizedDayName = dayName.charAt(0).toUpperCase() + dayName.slice(1);
---

<!-- DISEÑO DESKTOP - visible en md: y superior -->
<div class="hidden md:block bg-white border-b border-gray-200 -mx-4 lg:-mx-4 mb-6">
  <!-- Capa 1: Navegación y título -->
  <div class="max-w-7xl mx-auto px-4 py-3">
    <div class="flex items-center justify-between">
      <!-- Navegación izquierda -->
      <div class="flex items-center gap-2">
        <button id="prevWeek" class="flex items-center gap-1 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Anterior
        </button>

        <button id="todayBtn" class="px-3 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
          Hoy
        </button>

        <button id="nextWeek" class="flex items-center gap-1 px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
          Siguiente
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <div class="h-6 w-px bg-gray-200 mx-2"></div>

        <input
          type="date"
          id="dateSelector"
          class="px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          value={currentDate.toISOString().split('T')[0]}
        />
      </div>

      <!-- Título central -->
      <div class="text-center">
        <h1 id="weekTitleDesktop" class="text-lg font-bold text-gray-900">{weekTitle}</h1>
        <p id="weekSubtitleDesktop" class="text-sm text-gray-500">Semana {weekNumber} · {capitalizedDayName}</p>
      </div>

      <!-- Acciones derecha -->
      <div class="flex items-center gap-2">
        <a href="/user-history" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Historial
        </a>

        <a href="/program/CalenderView" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors shadow-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Ver Calendario
        </a>
      </div>
    </div>
  </div>

  <!-- Capa 2: Herramientas -->
  <div class="bg-gray-50 border-t border-gray-100">
    <div class="max-w-7xl mx-auto px-4 py-2">
      <div class="flex items-center justify-between">
        <!-- Búsqueda -->
        <div class="relative w-72">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            id="searchInputDesktop"
            placeholder="Buscar usuario..."
            class="w-full pl-10 pr-4 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
          />
        </div>

        <!-- Herramientas centrales -->
        <div class="flex items-center gap-1 bg-white rounded-lg border border-gray-200 p-1">
          <select id="preajustesSelect" class="px-3 py-1.5 text-sm border-0 bg-transparent focus:ring-0 cursor-pointer">
            <option value="">PreAjustes</option>
            <option value="cargar">Cargar Preajuste</option>
            <option value="guardar">Guardar Preajuste</option>
          </select>

          <div class="h-5 w-px bg-gray-200"></div>

          <button id="copyPreviousWeekBtn" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors" title="Copiar semana anterior">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
          </button>

          <button id="undoBtn" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Deshacer (Ctrl+Z)" disabled>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
            </svg>
          </button>

          <button id="redoBtn" class="p-1.5 text-gray-500 hover:text-gray-700 hover:bg-gray-100 rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" title="Rehacer (Ctrl+Y)" disabled>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
            </svg>
          </button>

          <div class="h-5 w-px bg-gray-200"></div>

          <button id="validateCapitanesBtn" class="p-1.5 text-amber-500 hover:text-amber-600 hover:bg-amber-50 rounded transition-colors" title="Verificar capitanes">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
            </svg>
          </button>
        </div>

        <!-- Guardar -->
        <button id="saveBtn" class="flex items-center gap-2 px-5 py-2 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 rounded-lg transition-colors shadow-sm">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>

<!-- DISEÑO MÓVIL - visible solo en pantallas pequeñas -->
<div class="md:hidden bg-white shadow-lg rounded-2xl mx-0 mb-4 overflow-hidden border border-gray-100">
  <!-- Header principal -->
  <div class="p-4">
    <!-- Navegación -->
    <div class="flex items-center justify-between mb-3">
      <button id="prevWeekMobile" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 hover:bg-gray-200 active:scale-95 transition-all">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
      </button>

      <div class="text-center">
        <h1 id="weekTitleMobile" class="text-lg font-bold text-gray-900">{weekTitle}</h1>
        <p id="weekSubtitleMobile" class="text-sm text-gray-500">Semana {weekNumber} · {currentDate.getFullYear()}</p>
      </div>

      <button id="nextWeekMobile" class="w-10 h-10 flex items-center justify-center rounded-xl bg-gray-100 hover:bg-gray-200 active:scale-95 transition-all">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>

    <!-- Botones de acción rápida -->
    <div class="flex items-center gap-2">
      <button id="todayBtnMobile" class="flex-1 py-2.5 text-sm font-medium text-blue-600 bg-blue-50 rounded-xl hover:bg-blue-100 transition-colors">
        Hoy
      </button>
      <button id="toggleToolsBtn" class="flex-1 py-2.5 text-sm font-medium text-gray-600 bg-gray-100 rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
        </svg>
        Herramientas
        <svg id="toolsChevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Panel de herramientas expandible -->
  <div id="toolsPanel" class="hidden p-4 bg-gray-50 border-t border-gray-100 space-y-3">
    <!-- Búsqueda -->
    <div class="relative">
      <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
      </svg>
      <input
        type="text"
        id="searchInputMobile"
        placeholder="Buscar usuario..."
        class="w-full pl-10 pr-4 py-2.5 text-sm border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white"
      />
    </div>

    <!-- Herramientas en grid -->
    <div class="grid grid-cols-4 gap-2">
      <button id="copyWeekBtnMobile" class="flex flex-col items-center gap-1 p-3 bg-white rounded-xl border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
        </svg>
        <span class="text-xs text-gray-600">Copiar</span>
      </button>

      <button id="undoBtnMobile" class="flex flex-col items-center gap-1 p-3 bg-white rounded-xl border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all disabled:opacity-50">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
        </svg>
        <span class="text-xs text-gray-600">Deshacer</span>
      </button>

      <button id="redoBtnMobile" class="flex flex-col items-center gap-1 p-3 bg-white rounded-xl border border-gray-200 hover:bg-gray-50 active:scale-95 transition-all disabled:opacity-50">
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 10h-10a8 8 0 00-8 8v2M21 10l-6 6m6-6l-6-6" />
        </svg>
        <span class="text-xs text-gray-600">Rehacer</span>
      </button>

      <button id="autoAssignBtnMobile" class="flex flex-col items-center gap-1 p-3 bg-amber-50 rounded-xl border border-amber-200 hover:bg-amber-100 active:scale-95 transition-all">
        <svg class="w-5 h-5 text-amber-600" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
        </svg>
        <span class="text-xs text-amber-700">Capitanes</span>
      </button>
    </div>

    <!-- PreAjustes y Fecha -->
    <div class="flex gap-2">
      <select id="preajustesSelectMobile" class="flex-1 px-4 py-2.5 text-sm border border-gray-200 rounded-xl bg-white">
        <option value="">Seleccionar PreAjuste...</option>
        <option value="cargar">Cargar Preajuste</option>
        <option value="guardar">Guardar Preajuste</option>
      </select>
      <input
        type="date"
        id="dateSelectorMobile"
        class="px-3 py-2.5 text-sm border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500"
        value={currentDate.toISOString().split('T')[0]}
      />
    </div>
  </div>

  <!-- Barra de acciones inferior -->
  <div class="flex items-center border-t border-gray-100">
    <a href="/user-history" class="flex-1 flex items-center justify-center gap-2 py-3.5 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      Historial
    </a>

    <div class="w-px h-8 bg-gray-200"></div>

    <a href="/program/CalenderView" class="flex-1 flex items-center justify-center gap-2 py-3.5 text-sm font-medium text-gray-600 hover:bg-gray-50 transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      Calendario
    </a>

    <div class="w-px h-8 bg-gray-200"></div>

    <button id="saveBtnMobile" class="flex-1 flex items-center justify-center gap-2 py-3.5 text-sm font-medium text-white bg-emerald-600 hover:bg-emerald-700 transition-colors">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      Guardar
    </button>
  </div>
</div>

<script>
  interface NavigationElements {
    prevWeek: HTMLButtonElement | null;
    nextWeek: HTMLButtonElement | null;
    todayBtn: HTMLButtonElement | null;
    dateSelector: HTMLInputElement | null;
    // Mobile elements
    prevWeekMobile: HTMLButtonElement | null;
    nextWeekMobile: HTMLButtonElement | null;
    todayBtnMobile: HTMLButtonElement | null;
    dateSelectorMobile: HTMLInputElement | null;
    toggleToolsBtn: HTMLButtonElement | null;
    toolsPanel: HTMLElement | null;
    toolsChevron: HTMLElement | null;
    // Search sync
    searchInputDesktop: HTMLInputElement | null;
    searchInputMobile: HTMLInputElement | null;
    // Save buttons
    saveBtn: HTMLButtonElement | null;
    saveBtnMobile: HTMLButtonElement | null;
    // Tools buttons
    copyPreviousWeekBtn: HTMLButtonElement | null;
    copyWeekBtnMobile: HTMLButtonElement | null;
    undoBtn: HTMLButtonElement | null;
    undoBtnMobile: HTMLButtonElement | null;
    redoBtn: HTMLButtonElement | null;
    redoBtnMobile: HTMLButtonElement | null;
    validateCapitanesBtn: HTMLButtonElement | null;
    autoAssignBtnMobile: HTMLButtonElement | null;
    // Presets
    preajustesSelect: HTMLSelectElement | null;
    preajustesSelectMobile: HTMLSelectElement | null;
  }

  interface TouchState {
    startX: number;
    startY: number;
    currentX: number;
    currentY: number;
    isDragging: boolean;
  }

  class WeekNavigation {
    private elements: NavigationElements;
    private currentDate: Date;
    private touchState: TouchState = {
      startX: 0,
      startY: 0,
      currentX: 0,
      currentY: 0,
      isDragging: false
    };

    constructor() {
      this.elements = {
        prevWeek: document.getElementById('prevWeek') as HTMLButtonElement,
        nextWeek: document.getElementById('nextWeek') as HTMLButtonElement,
        todayBtn: document.getElementById('todayBtn') as HTMLButtonElement,
        dateSelector: document.getElementById('dateSelector') as HTMLInputElement,
        // Mobile elements
        prevWeekMobile: document.getElementById('prevWeekMobile') as HTMLButtonElement,
        nextWeekMobile: document.getElementById('nextWeekMobile') as HTMLButtonElement,
        todayBtnMobile: document.getElementById('todayBtnMobile') as HTMLButtonElement,
        dateSelectorMobile: document.getElementById('dateSelectorMobile') as HTMLInputElement,
        toggleToolsBtn: document.getElementById('toggleToolsBtn') as HTMLButtonElement,
        toolsPanel: document.getElementById('toolsPanel'),
        toolsChevron: document.getElementById('toolsChevron'),
        // Search
        searchInputDesktop: document.getElementById('searchInputDesktop') as HTMLInputElement,
        searchInputMobile: document.getElementById('searchInputMobile') as HTMLInputElement,
        // Save
        saveBtn: document.getElementById('saveBtn') as HTMLButtonElement,
        saveBtnMobile: document.getElementById('saveBtnMobile') as HTMLButtonElement,
        // Tools
        copyPreviousWeekBtn: document.getElementById('copyPreviousWeekBtn') as HTMLButtonElement,
        copyWeekBtnMobile: document.getElementById('copyWeekBtnMobile') as HTMLButtonElement,
        undoBtn: document.getElementById('undoBtn') as HTMLButtonElement,
        undoBtnMobile: document.getElementById('undoBtnMobile') as HTMLButtonElement,
        redoBtn: document.getElementById('redoBtn') as HTMLButtonElement,
        redoBtnMobile: document.getElementById('redoBtnMobile') as HTMLButtonElement,
        validateCapitanesBtn: document.getElementById('validateCapitanesBtn') as HTMLButtonElement,
        autoAssignBtnMobile: document.getElementById('autoAssignBtnMobile') as HTMLButtonElement,
        // Presets
        preajustesSelect: document.getElementById('preajustesSelect') as HTMLSelectElement,
        preajustesSelectMobile: document.getElementById('preajustesSelectMobile') as HTMLSelectElement
      };

      const dateValue = this.elements.dateSelector?.value || this.elements.dateSelectorMobile?.value;
      this.currentDate = dateValue ? new Date(dateValue) : new Date();

      this.attachEventListeners();
      this.setupTouchGestures();
      this.setupToolsPanel();
      this.syncElements();
    }

    private attachEventListeners(): void {
      // Desktop navigation
      this.elements.prevWeek?.addEventListener('click', () => this.navigateWeek(-1));
      this.elements.nextWeek?.addEventListener('click', () => this.navigateWeek(1));
      this.elements.todayBtn?.addEventListener('click', () => this.goToToday());
      this.elements.dateSelector?.addEventListener('change', (e) => this.selectDate(e));

      // Mobile navigation
      this.elements.prevWeekMobile?.addEventListener('click', () => this.navigateWeek(-1));
      this.elements.nextWeekMobile?.addEventListener('click', () => this.navigateWeek(1));
      this.elements.todayBtnMobile?.addEventListener('click', () => this.goToToday());
      this.elements.dateSelectorMobile?.addEventListener('change', (e) => this.selectDate(e));
    }

    private setupToolsPanel(): void {
      const { toggleToolsBtn, toolsPanel, toolsChevron } = this.elements;

      if (toggleToolsBtn && toolsPanel && toolsChevron) {
        toggleToolsBtn.addEventListener('click', () => {
          const isHidden = toolsPanel.classList.contains('hidden');

          if (isHidden) {
            toolsPanel.classList.remove('hidden');
            toolsChevron.classList.add('rotate-180');
            toggleToolsBtn.classList.remove('text-gray-600', 'bg-gray-100');
            toggleToolsBtn.classList.add('text-white', 'bg-blue-600');
          } else {
            toolsPanel.classList.add('hidden');
            toolsChevron.classList.remove('rotate-180');
            toggleToolsBtn.classList.remove('text-white', 'bg-blue-600');
            toggleToolsBtn.classList.add('text-gray-600', 'bg-gray-100');
          }
        });
      }
    }

    private syncElements(): void {
      // Sync search inputs
      const syncSearch = (source: HTMLInputElement | null, target: HTMLInputElement | null) => {
        if (source && target) {
          source.addEventListener('input', () => {
            target.value = source.value;
            // Trigger the existing search functionality
            const event = new Event('input', { bubbles: true });
            const programSearch = document.getElementById('programSearchInput') as HTMLInputElement;
            if (programSearch) {
              programSearch.value = source.value;
              programSearch.dispatchEvent(event);
            }
          });
        }
      };

      syncSearch(this.elements.searchInputDesktop, this.elements.searchInputMobile);
      syncSearch(this.elements.searchInputMobile, this.elements.searchInputDesktop);

      // Sync save buttons
      this.elements.saveBtnMobile?.addEventListener('click', () => {
        this.elements.saveBtn?.click();
      });

      // Sync copy week buttons
      this.elements.copyWeekBtnMobile?.addEventListener('click', () => {
        this.elements.copyPreviousWeekBtn?.click();
      });

      // Sync undo/redo
      this.elements.undoBtnMobile?.addEventListener('click', () => {
        this.elements.undoBtn?.click();
      });
      this.elements.redoBtnMobile?.addEventListener('click', () => {
        this.elements.redoBtn?.click();
      });

      // Sync validate/auto-assign buttons
      this.elements.autoAssignBtnMobile?.addEventListener('click', () => {
        this.elements.validateCapitanesBtn?.click();
      });

      // Sync presets
      this.elements.preajustesSelectMobile?.addEventListener('change', (e) => {
        const value = (e.target as HTMLSelectElement).value;
        if (this.elements.preajustesSelect) {
          this.elements.preajustesSelect.value = value;
          this.elements.preajustesSelect.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });
    }

    private setupTouchGestures(): void {
      const container = document.getElementById('currentView');
      if (!container) return;

      container.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
      container.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: true });
      container.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: true });

      container.addEventListener('mousedown', (e) => this.handleMouseStart(e));
      container.addEventListener('mousemove', (e) => this.handleMouseMove(e));
      container.addEventListener('mouseup', (e) => this.handleMouseEnd(e));
      container.addEventListener('mouseleave', (e) => this.handleMouseEnd(e));
    }

    private handleTouchStart(e: TouchEvent): void {
      if (e.touches.length !== 1) return;
      const touch = e.touches[0];
      this.touchState.startX = touch.clientX;
      this.touchState.startY = touch.clientY;
      this.touchState.isDragging = true;
    }

    private handleTouchMove(e: TouchEvent): void {
      if (!this.touchState.isDragging || e.touches.length !== 1) return;
      const touch = e.touches[0];
      this.touchState.currentX = touch.clientX;
      this.touchState.currentY = touch.clientY;
    }

    private handleTouchEnd(e: TouchEvent): void {
      if (!this.touchState.isDragging) return;
      this.processSwipeGesture();
      this.resetTouchState();
    }

    private handleMouseStart(e: MouseEvent): void {
      this.touchState.startX = e.clientX;
      this.touchState.startY = e.clientY;
      this.touchState.isDragging = true;
    }

    private handleMouseMove(e: MouseEvent): void {
      if (!this.touchState.isDragging) return;
      this.touchState.currentX = e.clientX;
      this.touchState.currentY = e.clientY;
    }

    private handleMouseEnd(e: MouseEvent): void {
      if (!this.touchState.isDragging) return;
      this.processSwipeGesture();
      this.resetTouchState();
    }

    private processSwipeGesture(): void {
      const deltaX = this.touchState.currentX - this.touchState.startX;
      const deltaY = Math.abs(this.touchState.currentY - this.touchState.startY);

      const minSwipeDistance = 50;
      const maxVerticalMovement = 100;

      if (Math.abs(deltaX) > minSwipeDistance && deltaY < maxVerticalMovement) {
        if (deltaX > 0) {
          this.navigateWeek(-1);
          this.showSwipeFeedback('← Semana anterior');
        } else {
          this.navigateWeek(1);
          this.showSwipeFeedback('Semana siguiente →');
        }
      }
    }

    private showSwipeFeedback(message: string): void {
      const feedback = document.createElement('div');
      feedback.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-opacity duration-300';
      feedback.textContent = message;
      document.body.appendChild(feedback);

      setTimeout(() => {
        feedback.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(feedback);
        }, 300);
      }, 1500);
    }

    private resetTouchState(): void {
      this.touchState = {
        startX: 0,
        startY: 0,
        currentX: 0,
        currentY: 0,
        isDragging: false
      };
    }

    private navigateWeek(direction: number): void {
      const newDate = new Date(this.currentDate);
      newDate.setDate(newDate.getDate() + (direction * 7));
      this.updateDate(newDate);
    }

    private goToToday(): void {
      this.updateDate(new Date());
    }

    private selectDate(event: Event): void {
      const target = event.target as HTMLInputElement;
      const selectedDate = new Date(target.value);
      this.updateDate(selectedDate);
    }

    private updateDate(newDate: Date): void {
      this.currentDate = newDate;
      const dateString = newDate.toISOString().split('T')[0];

      // Update both date selectors
      if (this.elements.dateSelector) this.elements.dateSelector.value = dateString;
      if (this.elements.dateSelectorMobile) this.elements.dateSelectorMobile.value = dateString;

      // Clear cache before navigating
      if (typeof window !== 'undefined' && (window as any).clearUsersCache) {
        (window as any).clearUsersCache();
      }

      // Redirect to new date
      const url = new URL(window.location.href);
      url.searchParams.set('date', dateString);
      window.location.href = url.toString();
    }
  }

  // Initialize navigation when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    new WeekNavigation();
  });
</script>
