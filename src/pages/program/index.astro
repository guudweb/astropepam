---
import Layout from "../../layouts/Layout.astro";
import { db, Usuario } from "astro:db";

const allUsers = await db.select().from(Usuario);

const getUsersForTurno = (day: string, turno: string) => {
  return allUsers
    .filter((user) => {
      const disponibilidad =
        typeof user.disponibilidad === "string"
          ? JSON.parse(user.disponibilidad)
          : {};
      return disponibilidad[day] && disponibilidad[day].includes(turno);
    })
    .map((user) => ({
      ...user,
      telefono: user.telefono,
    }));
};

const days = [
  //"lunes",
  "martes",
  "miercoles",
  "jueves",
  "viernes",
  "sabado",
  "domingo",
];
const turnos = ["T1", "T2", "T3", "T4"];

const usersDisponibilidad = {};

days.forEach((day) => {
  usersDisponibilidad[day] = {};
  turnos.forEach((turno) => {
    usersDisponibilidad[day][turno] = getUsersForTurno(day, turno);
  });
});

const getWeekDates = (weekOffset: number) => {
  const startOfWeek = new Date();
  startOfWeek.setDate(
    startOfWeek.getDate() - startOfWeek.getDay() + 1 + weekOffset * 7
  );
  const dates = [];
  for (let i = 0; i < 7; i++) {
    const date = new Date(startOfWeek);
    date.setDate(startOfWeek.getDate() + i);
    dates.push(date);
  }
  return dates;
};

let weekOffset = 0;
let weekDates = getWeekDates(weekOffset);
---

<Layout title="program">
  <div class="container mx-auto mt-8 text-center">
    <div class="flex justify-between mb-4">
      <button class="bg-blue-500 text-white px-4 py-2 rounded" id="prevWeekBtn">
        Semana Anterior
      </button>
      <button class="bg-blue-500 text-white px-4 py-2 rounded" id="nextWeekBtn">
        Semana Siguiente
      </button>
    </div>
    <a href="/program/CalenderView"
      ><button
        class="bg-green-500 text-white px-4 py-2 rounded mb-4"
        id="CalenderViewBtn"
      >
        Ver Calendario
      </button></a
    >
    <button class="bg-blue-500 text-white px-4 py-2 rounded mb-4" id="saveBtn"
      >Guardar Cambios</button
    >
    <a href="/user-history">
      <button class="bg-yellow-500 text-white px-4 py-2 rounded">
        Historial de Users
      </button>
    </a>
    <div id="currentView">
      {
        days.map((day, dayIndex) => (
          <div class="mb-8">
            {" "}
            <h2 class="text-xl font-bold mb-4 week-date">
              {" "}
              {day.charAt(0).toUpperCase() + day.slice(1)} -{" "}
              {weekDates[dayIndex].toLocaleDateString()}{" "}
            </h2>{" "}
            <table>
              {" "}
              {turnos.map((turno) => (
                <tr>
                  {" "}
                  <td class="px-4 py-2 border-b">{turno}</td>{" "}
                  <td class="px-4 py-2 border-b">
                    {" "}
                    {[...Array(4)].map((_, index) => (
                      <div class="inline-block mr-2">
                        {" "}
                        <select
                          class="border border-gray-300 rounded px-2 py-1"
                          data-day={day}
                          data-turno={turno}
                          data-index={index}
                          data-date={
                            weekDates[dayIndex].toISOString().split("T")[0]
                          }
                        >
                          {" "}
                          {/* Opción para dejar el select vacío */}{" "}
                          {usersDisponibilidad[day][turno].map(
                            ({ nombre, Congregacion }) => (
                              <option
                                value={nombre}
                                data-congregacion-id={Congregacion}
                              >
                                {" "}
                                {nombre}{" "}
                              </option>
                            )
                          )}{" "}
                          <option value="add">Añadir usuario</option>{" "}
                          <option value="" />{" "}
                        </select>
                        <span
                          class="icon"
                          id={`icon-${day}-${turno}-${index}`}
                        />{" "}
                      </div>
                    ))}{" "}
                  </td>{" "}
                </tr>
              ))}{" "}
            </table>{" "}
          </div>
        ))
      }
    </div>
    <!-- Modal -->
    <div
      id="userModal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-8 rounded shadow-lg">
        <h2 class="text-xl mb-4">Seleccionar Usuario</h2>
        <input
          type="text"
          id="userSearch"
          class="border border-gray-300 rounded px-2 py-1 mb-4"
          placeholder="Buscar usuario..."
        />
        <ul id="userList" class="max-h-60 overflow-y-auto">
          {
            allUsers.map((user) => (
              <li class="mb-2">
                <button
                  class="bg-blue-500 text-white w-full px-2 py-1 rounded user-select-btn"
                  data-username={user.nombre}
                  data-congregacion-id={user.Congregacion}
                >
                  {user.nombre}
                </button>
              </li>
            ))
          }
        </ul>
        <button
          class="mt-4 bg-red-500 text-white px-4 py-2 rounded"
          id="closeModalBtn"
        >
          Cerrar
        </button>
      </div>
    </div>

    <!-- Popup de advertencia -->
    <div
      id="warningPopup"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden"
    >
      <div class="bg-white p-4 rounded shadow-lg">
        <h2 class="text-xl mb-4">Advertencia</h2>
        <p id="warningMessage"></p>
        <button
          class="mt-4 bg-red-500 text-white px-4 py-2 rounded"
          id="closeWarningBtn"
        >
          Cerrar
        </button>
      </div>
    </div>
  </div>
</Layout>

<script>
  let currentDate = new Date();
  const days = [
    "lunes",
    "martes",
    "miercoles",
    "jueves",
    "viernes",
    "sabado",
    "domingo",
  ];

  // Function to load week data
  const loadWeekData = async () => {
    // Calculate the start date of the week
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);

    try {
      const response = await fetch(
        `/api/getWeekData.json?date=${startOfWeek.toISOString().split("T")[0]}`
      );
      const currentWeekData = await response.json();
      document.querySelectorAll("select").forEach((select) => {
        const day = select.dataset.day;
        const turno = select.dataset.turno;
        const index = select.dataset.index;
        const value = currentWeekData[`${day}-${turno}-${index}`] || "";
        select.value = value;
      });
    } catch (error) {
      console.error("Error loading week data:", error);
    }
  };

  // Function to save week data
  const saveWeekData = async () => {
    const currentWeekData = {};
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
    const weekDate = startOfWeek.toISOString().split("T")[0];

    document.querySelectorAll("select").forEach(async (select) => {
      const day = select.dataset.day;
      const turno = select.dataset.turno;
      const index = select.dataset.index;
      const userName = select.value;

      if (userName) {
        // Only save if a user is selected
        currentWeekData[`${day}-${turno}-${index}`] = userName;

        // Save user selection to UserHistory table
        await fetch("/api/saveUserHistory.json", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            userName,
            date: weekDate, // Use the week date
            day,
            turno,
            indexValue: index,
          }),
        });
      }
    });

    await fetch("/api/saveWeekData.json", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        date: weekDate, // Use the same week date
        weekData: currentWeekData,
      }),
    });
  };

  // Function to update week dates in the UI
  const updateWeekDates = () => {
    const dates = getWeekDates(currentDate);
    document.querySelectorAll(".week-date").forEach((element, index) => {
      element.textContent = `${days[index].charAt(0).toUpperCase() + days[index].slice(1)} - ${dates[index].toLocaleDateString()}`;
    });
  };

  // Function to get week dates
  const getWeekDates = (currentDate: string | number | Date) => {
    const startOfWeek = new Date(currentDate);
    startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + 1);
    const dates = [];
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(startOfWeek.getDate() + i);
      dates.push(date);
    }
    return dates;
  };

  // Buscador para el modal
  document.getElementById("userSearch").addEventListener("input", function () {
    const searchValue = (this as HTMLInputElement).value.toLowerCase();
    const userList = document.getElementById("userList");
    const users = userList.getElementsByTagName("li");

    Array.from(users).forEach((user) => {
      const userName = user
        .getElementsByTagName("button")[0]
        .dataset.username.toLowerCase();
      if (userName.includes(searchValue)) {
        user.style.display = "";
      } else {
        user.style.display = "none";
      }
    });
  });

  const prevWeekBtn = document.getElementById("prevWeekBtn");
  const nextWeekBtn = document.getElementById("nextWeekBtn");
  const saveBtn = document.getElementById("saveBtn");
  // Add event listeners for week navigation buttons
  prevWeekBtn.addEventListener("click", async () => {
    currentDate.setDate(currentDate.getDate() - 7);
    updateWeekDates();
    await loadWeekData();
    document.querySelectorAll("select").forEach((select) => {
      checkUserAssignment(select);
    });
  });

  nextWeekBtn.addEventListener("click", async () => {
    currentDate.setDate(currentDate.getDate() + 7);
    updateWeekDates();
    await loadWeekData();
    document.querySelectorAll("select").forEach((select) => {
      checkUserAssignment(select);
    });
  });

  import { Notyf } from "notyf";
  import "notyf/notyf.min.css";

  // Crear una instancia de Notyf
  const notyf = new Notyf({
    duration: 6000,
  });

  // Load week data when the DOM is fully loaded
  document.addEventListener("DOMContentLoaded", async () => {
    await loadWeekData();

    // Set initial values of the selects based on fetched week data
    const weekData = await fetchWeekData(new Date());

    document.querySelectorAll("select").forEach((select) => {
      const day = select.dataset.day;
      const turno = select.dataset.turno;
      const index = select.dataset.index;

      if (weekData[`${day}-${turno}-${index}`]) {
        const value = weekData[`${day}-${turno}-${index}`];
        const optionExists = Array.from(select.options).some(
          (option) => option.value === value
        );

        if (!optionExists) {
          const newOption = document.createElement("option");
          newOption.value = value;
          newOption.text = value;
          select.appendChild(newOption);
        }

        select.value = value;
      }

      // Verificar si el select no está vacío
      if (select.value) {
        // Verificar si el usuario está en la lista de opciones del select
        const userName = select.value;
        const icon = document.getElementById(`icon-${day}-${turno}-${index}`);

        // Verificar si el usuario ya está asignado en otro turno de la semana
        const assignedTurns = [];
        document.querySelectorAll("select").forEach((otherSelect) => {
          if (otherSelect !== select && otherSelect.value === userName) {
            const otherDay = otherSelect.dataset.day;
            const otherTurno = otherSelect.dataset.turno;
            assignedTurns.push(`${otherDay} en el turno ${otherTurno}`);
          }
        });

        if (assignedTurns.length > 0) {
          icon.innerHTML += "⚠️"; // Icono para ya asignado
          // notyf.error(
          //   `El usuario ${userName} ya participa esta semana en ${assignedTurns.join(", ")}.`
          // );
        }
      }
    });
  });

  function checkUserAssignment(select: HTMLSelectElement) {
    if (select.value) {
      // Verificar si el usuario ya está asignado en otro turno de la semana
      const userName = select.value;
      const day = select.dataset.day;
      const turno = select.dataset.turno;
      const index = select.dataset.index;
      const icon = document.getElementById(`icon-${day}-${turno}-${index}`);

      const assignedTurns = [];
      document.querySelectorAll("select").forEach((otherSelect) => {
        if (otherSelect !== select && otherSelect.value === userName) {
          const otherDay = otherSelect.dataset.day;
          const otherTurno = otherSelect.dataset.turno;
          assignedTurns.push(`${otherDay} en el turno ${otherTurno}`);
        }
      });

      if (assignedTurns.length > 0) {
        icon.innerHTML = "⚠️"; // Icono para ya asignado
        notyf.error(
          `El usuario ${userName} ya participa esta semana en ${assignedTurns.join(", ")}.`
        );
      } else {
        icon.innerHTML = ""; // Limpiar icono si no hay conflictos
      }
    } else {
      const day = select.dataset.day;
      const turno = select.dataset.turno;
      const index = select.dataset.index;
      const icon = document.getElementById(`icon-${day}-${turno}-${index}`);
      icon.innerHTML = ""; // Limpiar icono si el select está vacío
    }
  }

  // Agregar evento click para los botones del modal
  document.querySelectorAll(".user-select-btn").forEach((button) => {
    button.addEventListener("click", (event) => {
      const target = event.target as HTMLElement;
      const userName = target.dataset.username;
      const select = document.querySelector(
        "select[data-day][data-turno][data-index]"
      ) as HTMLSelectElement;
      select.value = userName;
      checkUserAssignment(select);
    });
  });

  // Agregar evento change fuera del evento DOMContentLoaded
  document.querySelectorAll("select").forEach((select) => {
    select.addEventListener("change", () => {
      checkUserAssignment(select);
    });
  });

  // Add event listener for save button
  saveBtn.addEventListener("click", async () => {
    await saveWeekData();
  });

  // Set initial values of the selects based on fetched week data
  const weekData = await fetchWeekData(new Date());

  function checkAvailability(select: HTMLSelectElement) {
    const day = select.dataset.day;
    const turno = select.dataset.turno;
    const index = select.dataset.index;
    const userName = select.value;
    const icon = document.getElementById(`icon-${day}-${turno}-${index}`);

    // Verificar si el usuario ya está asignado en otro turno de la semana
    const assignedTurns = [];
    document.querySelectorAll("select").forEach((otherSelect) => {
      if (otherSelect !== select && otherSelect.value === userName) {
        const otherDay = otherSelect.dataset.day;
        const otherTurno = otherSelect.dataset.turno;
        assignedTurns.push(`${otherDay} en el turno ${otherTurno}`);
      }
    });

    if (assignedTurns.length > 0) {
      icon.innerHTML += "⚠️"; // Icono para ya asignado
      alert(
        `El usuario ${userName} ya participa esta semana en ${assignedTurns.join(", ")}.`
      );
    }
  }

  async function fetchWeekData(date: Date) {
    try {
      const response = await fetch(
        `/api/getWeekData.json?date=${date.toISOString().split("T")[0]}`
      );
      const data = await response.json();

      return data;
    } catch (error) {
      console.error("Error fetching week data:", error);
      return {};
    }
  }

  // Modal and user selection logic
  const modal = document.getElementById("userModal");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const userSelectButtons = document.querySelectorAll(".user-select-btn");
  const addUserButtons = document.querySelectorAll("select");

  addUserButtons.forEach((select) => {
    select.addEventListener("change", (event) => {
      const target = event.target as HTMLSelectElement;
      if (target.value === "add") {
        const day = select.dataset.day;
        const turno = select.dataset.turno;
        const index = select.dataset.index;
        modal.classList.remove("hidden");
        modal.dataset.day = day;
        modal.dataset.turno = turno;
        modal.dataset.index = index;
      }
    });
  });

  closeModalBtn.addEventListener("click", () => {
    modal.classList.add("hidden");
  });

  userSelectButtons.forEach((button) => {
    button.addEventListener("click", (event) => {
      const target = event.target as HTMLElement;
      const userName = (target.dataset as DOMStringMap).username;
      const modal = document.getElementById("userModal") as HTMLElement;
      const day = (modal.dataset as DOMStringMap).day;
      const turno = (modal.dataset as DOMStringMap).turno;
      const index = (modal.dataset as DOMStringMap).index;
      const select = document.querySelector(
        `select[data-day="${day}"][data-turno="${turno}"][data-index="${index}"]`
      ) as HTMLSelectElement;
      const option = document.createElement("option");
      option.value = userName;
      option.text = userName;
      select.appendChild(option);
      select.value = userName;
      modal.classList.add("hidden");
    });
  });

  const warningPopup = document.getElementById("warningPopup");
  const warningMessage = document.getElementById("warningMessage");
  const closeWarningBtn = document.getElementById("closeWarningBtn");

  closeWarningBtn.addEventListener("click", () => {
    warningPopup.classList.add("hidden");
  });

  const showWarningPopup = (message: string) => {
    warningMessage.textContent = message;
    warningPopup.classList.remove("hidden");
  };

  // Lógica de selección de usuario
  userSelectButtons.forEach((button) => {
    button.addEventListener("click", (event) => {
      const target = event.target as HTMLElement;
      const userName = (target.dataset as DOMStringMap).username;
      const userCongregacionId = (target.dataset as DOMStringMap)
        .congregacionId;

      // Check if userCongregacionId is defined
      if (!userCongregacionId) {
        console.error("userCongregacionId is undefined:", target.dataset);
        return;
      }

      const modal = document.getElementById("userModal") as HTMLElement;
      const day = (modal.dataset as DOMStringMap).day;
      const turno = (modal.dataset as DOMStringMap).turno;
      const index = Number((modal.dataset as DOMStringMap).index);

      // Validate dataset values
      if (!day || !turno || !Number.isFinite(index)) {
        console.error("Invalid dataset values:", day, turno, index);
        return;
      }

      const select = document.querySelector(
        `select[data-day="${day}"][data-turno="${turno}"][data-index="${index}"]`
      ) as HTMLSelectElement;
      const option = document.createElement("option");
      option.value = userName;
      option.text = userName;
      select.appendChild(option);
      select.value = userName;

      // Fetch congregation details using the congregation ID
      fetch(
        `/api/getCongregacionDetails.json?congregacionId=${userCongregacionId}`
      )
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          const congregacionName = data.nombre; // Assuming 'nombre' is the congregation name field
          if (data.diaReunion === day && data.turnoReunion === turno) {
            showWarningPopup(
              `El usuario ${userName} tiene reunión el ${day} en el turno ${turno} en la congregación ${congregacionName}.`
            );
          }
        })
        .catch((error) => {
          console.error("Fetch error:", error);
        });

      modal.classList.add("hidden");
    });
  });
</script>
